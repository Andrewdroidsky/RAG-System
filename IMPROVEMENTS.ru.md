# RAG Documents System - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã RAG Documents —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏, –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –∫–∞—á–µ—Å—Ç–≤–∞.

## üåç Language / –Ø–∑—ã–∫

[üá∫üá∏ English](IMPROVEMENTS.md) | [üá∑üá∫ –†—É—Å—Å–∫–∏–π](IMPROVEMENTS.ru.md)

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã —É–ª—É—á—à–µ–Ω–∏–π](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã-—É–ª—É—á—à–µ–Ω–∏–π)
- [–ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤](#–º–∞—Ç—Ä–∏—Ü–∞-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤)
- [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-—É–ª—É—á—à–µ–Ω–∏—è)
- [–í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
- [–°—Ä–µ–¥–Ω–µ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#—Å—Ä–µ–¥–Ω–µ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
- [–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)
- [–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–¥–µ—Ç–∞–ª–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- [–û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–æ—Ü–µ–Ω–∫–∞-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

## üîç –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã —É–ª—É—á—à–µ–Ω–∏–π

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ç–∏–≤ —Ü–µ–ª–µ–≤–æ–π

```
–¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï                    –¶–ï–õ–ï–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ—Å—Ç–æ–µ         ‚îÇ    ‚Üí             ‚îÇ –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ   ‚îÇ
‚îÇ —Ä–∞–∑–±–∏–µ–Ω–∏–µ       ‚îÇ                  ‚îÇ —Ä–∞–∑–±–∏–µ–Ω–∏–µ       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –¢–æ–ª—å–∫–æ          ‚îÇ    ‚Üí             ‚îÇ –ì–∏–±—Ä–∏–¥–Ω—ã–π       ‚îÇ
‚îÇ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ ‚îÇ                  ‚îÇ –ø–æ–∏—Å–∫ + BM25    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ë–∞–∑–æ–≤–∞—è         ‚îÇ    ‚Üí             ‚îÇ –ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–∞—è    ‚îÇ
‚îÇ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è       ‚îÇ                  ‚îÇ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è

1. **–ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è**: 60% ‚Üí 85% —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞
2. **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
3. **–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –∏ —Å–∞–º–æ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 10,000+ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: <3 —Å–µ–∫—É–Ω–¥ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞

## üìä –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

| –£–ª—É—á—à–µ–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ |
|-----------|-----------|-----------|---------|------------------|
| –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | 2-3 –Ω–µ–¥–µ–ª–∏ |
| –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | 3-4 –Ω–µ–¥–µ–ª–∏ |
| –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ | üü° –í—ã—Å–æ–∫–∏–π | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | 2-3 –Ω–µ–¥–µ–ª–∏ |
| –¶–µ–ø–æ—á–∫–∞ –º—ã—Å–ª–µ–π | üü° –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | 1-2 –Ω–µ–¥–µ–ª–∏ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ | üü° –í—ã—Å–æ–∫–∏–π | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ | 3-4 –Ω–µ–¥–µ–ª–∏ |
| –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ | üü¢ –°—Ä–µ–¥–Ω–∏–π | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | 6-8 –Ω–µ–¥–µ–ª—å |
| –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å | üîµ –ù–∏–∑–∫–∏–π | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ | 8-12 –Ω–µ–¥–µ–ª—å |

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ–∫—É—â–µ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º —Ç–µ—Ä—è–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫—É—é —Å–≤—è–∑–Ω–æ—Å—Ç—å

**–†–µ—à–µ–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Å–µ–º–∞–Ω—Ç–∏–∫–∏

```typescript
// src/lib/advancedChunking.ts
interface SemanticChunker {
  chunkBySimilarity(text: string, chunkSize: number): SemanticChunk[]
  preserveStructure(chunks: SemanticChunk[]): StructuredChunk[]
  calculateOptimalOverlap(content: string): number
}

class AdaptiveSemanticChunker implements SemanticChunker {
  private embeddings: EmbeddingsManager
  private sentenceSplitter: SentenceSplitter

  async chunkBySimilarity(text: string, targetSize: number = 1000): Promise<SemanticChunk[]> {
    // 1. –†–∞–∑–±–∏—Ç—å –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    const sentences = this.sentenceSplitter.split(text)

    // 2. –ü–æ–ª—É—á–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    const sentenceEmbeddings = await this.embeddings.embedBatch(sentences)

    // 3. –í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ö–æ–¥—Å—Ç–≤–æ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
    const similarities = this.calculateSimilarities(sentenceEmbeddings)

    // 4. –ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞–¥–µ–Ω–∏—è —Å—Ö–æ–¥—Å—Ç–≤–∞
    const boundaries = this.findSemanticBoundaries(similarities, targetSize)

    // 5. –°–æ–∑–¥–∞—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ–º
    return this.createChunksWithOverlap(sentences, boundaries)
  }

  private calculateSimilarities(embeddings: number[][]): number[] {
    const similarities: number[] = []
    for (let i = 0; i < embeddings.length - 1; i++) {
      similarities.push(this.cosineSimilarity(embeddings[i], embeddings[i + 1]))
    }
    return similarities
  }

  private findSemanticBoundaries(similarities: number[], targetSize: number): number[] {
    const boundaries: number[] = [0]
    let currentChunkSize = 0

    for (let i = 0; i < similarities.length; i++) {
      currentChunkSize += this.estimateTokens(sentences[i])

      // –ì—Ä–∞–Ω–∏—Ü–∞, –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–µ–Ω –ò —Å—Ö–æ–¥—Å—Ç–≤–æ –Ω–∏–∑–∫–æ–µ
      if (currentChunkSize >= targetSize && similarities[i] < 0.7) {
        boundaries.push(i + 1)
        currentChunkSize = 0
      }
    }

    boundaries.push(similarities.length)
    return boundaries
  }
}
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**:

```typescript
// src/lib/embeddings.ts - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
export class EmbeddingsManager {
  private chunker: AdaptiveSemanticChunker

  async createEmbeddings(documents: ProcessedDocument[]): Promise<StoredDocument[]> {
    const results: StoredDocument[] = []

    for (const doc of documents) {
      // –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ
      const semanticChunks = await this.chunker.chunkBySimilarity(
        doc.sections.map(s => s.content).join('\n'),
        1000
      )

      // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
      const embeddings = await this.generateEmbeddings(semanticChunks)

      results.push({
        id: doc.filename,
        filename: doc.filename,
        chunks: embeddings,
        fullPages: doc.fullPages,
        createdAt: new Date().toISOString()
      })
    }

    return results
  }
}
```

### 2. –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ (–í–µ–∫—Ç–æ—Ä + BM25)

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–æ–ª—å–∫–æ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–æ–≤

**–†–µ—à–µ–Ω–∏–µ**: –ê–Ω—Å–∞–º–±–ª—å –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å BM25

```typescript
// src/lib/hybridSearch.ts
interface SearchResult {
  chunk: EmbeddedChunk
  vectorScore: number
  bm25Score: number
  combinedScore: number
}

class HybridSearchEngine {
  private vectorSearch: VectorSearchEngine
  private keywordSearch: BM25SearchEngine
  private reranker: CrossEncoderReranker

  async search(query: string, topK: number = 20): Promise<SearchResult[]> {
    // 1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤–µ–∫—Ç–æ—Ä–∞–º –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    const [vectorResults, bm25Results] = await Promise.all([
      this.vectorSearch.search(query, topK * 2),
      this.keywordSearch.search(query, topK * 2)
    ])

    // 2. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –≤–µ—Å–∞–º–∏
    const combinedResults = this.combineResults(vectorResults, bm25Results)

    // 3. –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ø-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    const rerankedResults = await this.reranker.rerank(query, combinedResults.slice(0, topK * 2))

    return rerankedResults.slice(0, topK)
  }

  private combineResults(
    vectorResults: VectorResult[],
    bm25Results: BM25Result[]
  ): SearchResult[] {
    const scoreMap = new Map<string, SearchResult>()

    // –î–æ–±–∞–≤–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    for (const result of vectorResults) {
      scoreMap.set(result.chunk.id, {
        chunk: result.chunk,
        vectorScore: result.score,
        bm25Score: 0,
        combinedScore: result.score * 0.7 // –í–µ—Å –≤–µ–∫—Ç–æ—Ä–∞: 70%
      })
    }

    // –î–æ–±–∞–≤–∏—Ç—å BM25 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    for (const result of bm25Results) {
      const existing = scoreMap.get(result.chunk.id)
      if (existing) {
        existing.bm25Score = result.score
        existing.combinedScore += result.score * 0.3 // –í–µ—Å BM25: 30%
      } else {
        scoreMap.set(result.chunk.id, {
          chunk: result.chunk,
          vectorScore: 0,
          bm25Score: result.score,
          combinedScore: result.score * 0.3
        })
      }
    }

    return Array.from(scoreMap.values())
      .sort((a, b) => b.combinedScore - a.combinedScore)
  }
}
```

**BM25 —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:

```typescript
// src/lib/bm25Search.ts
class BM25SearchEngine {
  private documents: BM25Document[] = []
  private idf: Map<string, number> = new Map()

  constructor(private k1: number = 1.2, private b: number = 0.75) {}

  indexDocuments(chunks: EmbeddedChunk[]): void {
    this.documents = chunks.map(chunk => ({
      id: chunk.id,
      chunk,
      terms: this.tokenize(chunk.content),
      length: chunk.content.split(' ').length
    }))

    this.calculateIDF()
  }

  search(query: string, topK: number): BM25Result[] {
    const queryTerms = this.tokenize(query)
    const scores: BM25Result[] = []

    for (const doc of this.documents) {
      const score = this.calculateBM25Score(queryTerms, doc)
      if (score > 0) {
        scores.push({ chunk: doc.chunk, score })
      }
    }

    return scores
      .sort((a, b) => b.score - a.score)
      .slice(0, topK)
  }

  private calculateBM25Score(queryTerms: string[], doc: BM25Document): number {
    let score = 0
    const avgDocLength = this.getAverageDocumentLength()

    for (const term of queryTerms) {
      const tf = doc.terms.filter(t => t === term).length
      const idf = this.idf.get(term) || 0

      const numerator = tf * (this.k1 + 1)
      const denominator = tf + this.k1 * (1 - this.b + this.b * (doc.length / avgDocLength))

      score += idf * (numerator / denominator)
    }

    return score
  }
}
```

### 3. –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Cross-Encoder

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∏—Å–∫ –º–æ–∂–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–†–µ—à–µ–Ω–∏–µ**: –î–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
// src/lib/reranking.ts
class CrossEncoderReranker {
  private model: CrossEncoderModel

  async rerank(query: string, candidates: SearchResult[]): Promise<SearchResult[]> {
    // 1. –ü–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã –∑–∞–ø—Ä–æ—Å-–¥–æ–∫—É–º–µ–Ω—Ç
    const rerankingScores = await this.computeRerankingScores(query, candidates)

    // 2. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏
    const rerankedResults = candidates.map((result, index) => ({
      ...result,
      rerankingScore: rerankingScores[index],
      finalScore: this.combineScores(result.combinedScore, rerankingScores[index])
    }))

    // 3. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–µ
    return rerankedResults.sort((a, b) => b.finalScore - a.finalScore)
  }

  private async computeRerankingScores(
    query: string,
    candidates: SearchResult[]
  ): Promise<number[]> {
    const pairs = candidates.map(candidate => ({
      query,
      document: candidate.chunk.content
    }))

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenAI –¥–ª—è –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏)
    const prompt = this.buildRerankingPrompt(query, pairs)
    const response = await this.openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: prompt }],
      temperature: 0
    })

    return this.parseRerankingResponse(response.choices[0].message.content)
  }

  private combineScores(originalScore: number, rerankingScore: number): number {
    // –í–∑–≤–µ—à–µ–Ω–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –∏ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
    return originalScore * 0.4 + rerankingScore * 0.6
  }
}
```

## üü° –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 4. –¶–µ–ø–æ—á–∫–∞ –º—ã—Å–ª–µ–π (Chain-of-Thought)

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç–≤–µ—Ç—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ

```typescript
// src/lib/chainOfThought.ts
interface ReasoningStep {
  step: number
  question: string
  evidence: EmbeddedChunk[]
  reasoning: string
  conclusion: string
}

class ChainOfThoughtProcessor {
  async processComplexQuery(query: string, documents: EmbeddedChunk[]): Promise<{
    steps: ReasoningStep[]
    finalAnswer: string
    confidence: number
  }> {
    // 1. –†–∞–∑–ª–æ–∂–∏—Ç—å —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–≤–æ–ø—Ä–æ—Å—ã
    const subQuestions = await this.decomposeQuery(query)

    // 2. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ–¥–≤–æ–ø—Ä–æ—Å
    const steps: ReasoningStep[] = []
    for (const [index, subQuestion] of subQuestions.entries()) {
      const step = await this.answerSubQuestion(subQuestion, documents, index + 1)
      steps.push(step)
    }

    // 3. –°–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
    const finalAnswer = await this.synthesizeFinalAnswer(query, steps)

    // 4. –û—Ü–µ–Ω–∏—Ç—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    const confidence = this.calculateConfidence(steps)

    return { steps, finalAnswer, confidence }
  }

  private async decomposeQuery(query: string): Promise<string[]> {
    const decompositionPrompt = `
    –†–∞–∑–ª–æ–∂–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Å–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å –Ω–∞ 2-4 –ø—Ä–æ—Å—Ç—ã—Ö –ø–æ–¥–≤–æ–ø—Ä–æ—Å–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ:

    –í–æ–ø—Ä–æ—Å: "${query}"

    –ü–æ–¥–≤–æ–ø—Ä–æ—Å—ã:
    1.`

    const response = await this.openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: decompositionPrompt }],
      temperature: 0
    })

    return this.parseSubQuestions(response.choices[0].message.content)
  }

  private async answerSubQuestion(
    question: string,
    documents: EmbeddedChunk[],
    stepNumber: number
  ): Promise<ReasoningStep> {
    // –ù–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–¥–≤–æ–ø—Ä–æ—Å–∞
    const relevantChunks = await this.findRelevantChunks(question, documents)

    // –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–∞
    const context = relevantChunks.map(chunk => chunk.content).join('\n\n')

    const reasoningPrompt = `
    –®–∞–≥ ${stepNumber}: –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.

    –í–æ–ø—Ä–æ—Å: ${question}

    –ö–æ–Ω—Ç–µ–∫—Å—Ç:
    ${context}

    –î–∞–π—Ç–µ:
    1. –í–∞—à–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ
    2. –ß–µ—Ç–∫–∏–π –≤—ã–≤–æ–¥
    `

    const response = await this.openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: reasoningPrompt }],
      temperature: 0.3
    })

    const { reasoning, conclusion } = this.parseReasoningResponse(response.choices[0].message.content)

    return {
      step: stepNumber,
      question,
      evidence: relevantChunks,
      reasoning,
      conclusion
    }
  }
}
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –∏ —Å–∞–º–æ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –æ—Ç–≤–µ—Ç—ã

**–†–µ—à–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤

```typescript
// src/lib/factChecking.ts
interface FactCheckResult {
  statement: string
  isSupported: boolean
  confidence: number
  supportingEvidence: EmbeddedChunk[]
  contradictingEvidence: EmbeddedChunk[]
}

class FactCheckingEngine {
  async verifyAnswer(
    answer: string,
    sources: EmbeddedChunk[]
  ): Promise<FactCheckResult[]> {
    // 1. –ò–∑–≤–ª–µ—á—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const statements = await this.extractClaims(answer)

    // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∂–¥–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const results: FactCheckResult[] = []
    for (const statement of statements) {
      const result = await this.checkStatement(statement, sources)
      results.push(result)
    }

    return results
  }

  private async checkStatement(
    statement: string,
    sources: EmbeddedChunk[]
  ): Promise<FactCheckResult> {
    // –ù–∞–π—Ç–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞ –∏ –ø—Ä–æ—Ç–∏–≤ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const supportingEvidence = await this.findSupportingEvidence(statement, sources)
    const contradictingEvidence = await this.findContradictingEvidence(statement, sources)

    // –û—Ü–µ–Ω–∏—Ç—å –æ–±—â—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const isSupported = this.evaluateSupport(supportingEvidence, contradictingEvidence)
    const confidence = this.calculateConfidence(supportingEvidence, contradictingEvidence)

    return {
      statement,
      isSupported,
      confidence,
      supportingEvidence,
      contradictingEvidence
    }
  }

  private async findSupportingEvidence(
    statement: string,
    sources: EmbeddedChunk[]
  ): Promise<EmbeddedChunk[]> {
    const verificationPrompt = `
    –ù–∞–π–¥–∏—Ç–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ç–µ–∫—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–¢ —Å–ª–µ–¥—É—é—â–µ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:
    "${statement}"

    –í–µ—Ä–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä—è–º–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç —ç—Ç–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
    `

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
    return this.searchForEvidence(statement, sources, 'supporting')
  }
}
```

### 6. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Ç–µ—Ä—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

**–†–µ—à–µ–Ω–∏–µ**: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```typescript
// src/lib/advancedDocumentProcessor.ts
interface StructuredDocument {
  metadata: DocumentMetadata
  hierarchy: DocumentNode[]
  tables: ExtractedTable[]
  figures: ExtractedFigure[]
  references: ExtractedReference[]
}

interface DocumentNode {
  type: 'heading' | 'paragraph' | 'list' | 'table' | 'figure'
  level: number
  content: string
  children: DocumentNode[]
  context: HierarchicalContext
}

class AdvancedDocumentProcessor {
  async processWithStructure(file: File): Promise<StructuredDocument> {
    const basicDocument = await this.basicProcessor.process(file)

    // 1. –ò–∑–≤–ª–µ—á—å –∏–µ—Ä–∞—Ä—Ö–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    const hierarchy = await this.extractHierarchy(basicDocument)

    // 2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü
    const tables = await this.extractTables(basicDocument)

    // 3. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø–∏—Å–∞—Ç—å —Ä–∏—Å—É–Ω–∫–∏
    const figures = await this.extractFigures(basicDocument)

    // 4. –ò–∑–≤–ª–µ—á—å —Å—Å—ã–ª–∫–∏ –∏ —Ü–∏—Ç–∞—Ç—ã
    const references = await this.extractReferences(basicDocument)

    return {
      metadata: basicDocument.metadata,
      hierarchy,
      tables,
      figures,
      references
    }
  }

  private async extractHierarchy(document: ProcessedDocument): Promise<DocumentNode[]> {
    const nodes: DocumentNode[] = []
    let currentContext: HierarchicalContext = { path: [], level: 0 }

    for (const section of document.sections) {
      const node = await this.processSection(section, currentContext)
      nodes.push(node)

      // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Å–µ–∫—Ü–∏–π
      if (node.type === 'heading') {
        currentContext = this.updateContext(currentContext, node)
      }
    }

    return this.buildHierarchicalTree(nodes)
  }
}
```

## üü¢ –°—Ä–µ–¥–Ω–µ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 7. –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ**: –ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä

```typescript
// server/api/documents/upload.ts (Next.js API Route)
export async function POST(request: Request) {
  const formData = await request.formData()
  const file = formData.get('file') as File

  // 1. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  const processed = await serverDocumentProcessor.process(file)

  // 2. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –±–∞—Ç—á–∞–º–∏
  const embeddings = await embeddingsService.createEmbeddings(processed)

  // 3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  await vectorDB.store(embeddings)

  return NextResponse.json({
    success: true,
    documentId: processed.id
  })
}
```

### 8. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∑–∞–º–µ–¥–ª—è—é—Ç —Å–∏—Å—Ç–µ–º—É

**–†–µ—à–µ–Ω–∏–µ**: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
// src/lib/caching.ts
class IntelligentCacheManager {
  private queryCache: LRUCache<string, RAGResponse>
  private embeddingCache: Map<string, number[]>
  private resultCache: TimedCache<string, SearchResult[]>

  async getCachedQuery(query: string): Promise<RAGResponse | null> {
    const cacheKey = this.generateQueryKey(query)
    return this.queryCache.get(cacheKey) || null
  }

  async cacheQueryResult(query: string, result: RAGResponse): Promise<void> {
    const cacheKey = this.generateQueryKey(query)
    this.queryCache.set(cacheKey, result)
  }

  private generateQueryKey(query: string): string {
    // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à
    const normalized = query.toLowerCase().trim()
    return crypto.createHash('sha256').update(normalized).digest('hex')
  }
}
```

## üîµ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 9. –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç

**–†–µ—à–µ–Ω–∏–µ**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

```typescript
// src/lib/multimodalProcessor.ts
class MultimodalProcessor {
  private visionModel: OpenAIVisionModel
  private audioProcessor: AudioTranscriptionService

  async processMultimodalDocument(file: File): Promise<MultimodalDocument> {
    const mediaType = this.detectMediaType(file)

    switch (mediaType) {
      case 'pdf_with_images':
        return this.processPDFWithImages(file)
      case 'video':
        return this.processVideo(file)
      case 'audio':
        return this.processAudio(file)
      default:
        return this.processTextOnly(file)
    }
  }

  private async processPDFWithImages(file: File): Promise<MultimodalDocument> {
    // 1. –ò–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const { text, images } = await this.extractPDFContent(file)

    // 2. –û–ø–∏—Å–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const imageDescriptions = await Promise.all(
      images.map(image => this.visionModel.describe(image))
    )

    // 3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
    return this.combineMultimodalContent(text, imageDescriptions)
  }
}
```

### 10. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–ª–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤

```typescript
// src/lib/abTesting.ts
class ABTestingFramework {
  private experiments: Map<string, Experiment> = new Map()

  async runExperiment(
    experimentName: string,
    query: string,
    variants: ExperimentVariant[]
  ): Promise<ExperimentResult> {
    // –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –≥—Ä—É–ø–ø—ã
    const userGroup = this.assignUserToGroup(experimentName)
    const variant = variants[userGroup]

    // –ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
    const startTime = Date.now()
    const result = await variant.algorithm.process(query)
    const endTime = Date.now()

    // –°–æ–±—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏
    const metrics = {
      responseTime: endTime - startTime,
      userSatisfaction: await this.collectFeedback(),
      accuracy: await this.evaluateAccuracy(result)
    }

    // –ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    await this.recordExperimentResult(experimentName, userGroup, metrics)

    return result
  }
}
```

## üß™ –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü–æ—ç—Ç–∞–ø–Ω—ã–π –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

#### –ù–µ–¥–µ–ª—è 1-2: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ
```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install sentence-transformers-js natural

# 2. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è
touch src/lib/semanticChunking.ts
touch src/lib/sentenceSplitter.ts

# 3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π
# –û–±–Ω–æ–≤–∏—Ç—å src/lib/embeddings.ts
```

#### –ù–µ–¥–µ–ª—è 3-4: BM25 –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
```bash
# 1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å BM25
touch src/lib/bm25Search.ts

# 2. –°–æ–∑–¥–∞—Ç—å –≥–∏–±—Ä–∏–¥–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–∏—Å–∫–∞
touch src/lib/hybridSearch.ts

# 3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å RAG engine
# –û–±–Ω–æ–≤–∏—Ç—å src/lib/ragQuery.ts
```

#### –ù–µ–¥–µ–ª—è 5-6: –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ü–µ–ø–æ—á–∫–∞ –º—ã—Å–ª–µ–π
```bash
# 1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
touch src/lib/reranking.ts

# 2. –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –º—ã—Å–ª–µ–π
touch src/lib/chainOfThought.ts

# 3. –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

```typescript
// tests/integration/ragImprovement.test.ts
describe('RAG System Improvements', () => {
  test('semantic chunking preserves context', async () => {
    const text = "Complex document with multiple topics..."
    const chunks = await semanticChunker.chunkBySimilarity(text, 1000)

    expect(chunks).toHaveLength(expectedChunkCount)
    expect(chunks[0].semanticCoherence).toBeGreaterThan(0.8)
  })

  test('hybrid search improves relevance', async () => {
    const query = "specific technical term"
    const hybridResults = await hybridSearch.search(query, 10)
    const vectorResults = await vectorSearch.search(query, 10)

    expect(hybridResults[0].combinedScore).toBeGreaterThan(vectorResults[0].score)
  })
})
```

## üìà –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ | –¶–µ–ª—å –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π | –°–ø–æ—Å–æ–± –∏–∑–º–µ—Ä–µ–Ω–∏—è |
|---------|---------|---------------------|------------------|
| –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ | ~60% | >85% | NDCG@10 –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –Ω–∞–±–æ—Ä–µ |
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ | 8-15 —Å–µ–∫ | <3 —Å–µ–∫ | –ú–µ–¥–∏–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–æ –æ—Ç–≤–µ—Ç–∞ |
| –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ | ~70% | >90% | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ü–µ–Ω–∫–∏ 1-5 |
| –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å | ~75% | >95% | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ |
| –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | ~3.2/5 | >4.5/5 | NPS –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |

### –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```typescript
// src/utils/benchmarking.ts
class PerformanceBenchmark {
  async runComprehensiveBenchmark(): Promise<BenchmarkReport> {
    const testQueries = this.loadTestQueries()
    const results: BenchmarkResult[] = []

    for (const query of testQueries) {
      const startTime = performance.now()

      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å–∏—Å—Ç–µ–º—É
      const currentResult = await this.currentRAG.query(query.question)
      const currentTime = performance.now() - startTime

      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É
      const improvedResult = await this.improvedRAG.query(query.question)
      const improvedTime = performance.now() - startTime

      // –û—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ
      const currentQuality = await this.evaluateQuality(currentResult, query.expectedAnswer)
      const improvedQuality = await this.evaluateQuality(improvedResult, query.expectedAnswer)

      results.push({
        query: query.question,
        currentTime,
        improvedTime,
        currentQuality,
        improvedQuality,
        improvement: improvedQuality - currentQuality
      })
    }

    return this.generateReport(results)
  }
}
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

```typescript
// src/lib/monitoring.ts
class ProductionMonitoring {
  private metrics: MetricsCollector

  async trackQueryPerformance(query: string, result: RAGResponse): Promise<void> {
    const metrics = {
      timestamp: new Date(),
      query: this.hashQuery(query), // –ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
      responseTime: result.metadata.processingTime,
      tokensUsed: result.tokensUsed,
      sourcesCount: result.sources.length,
      userSatisfaction: await this.collectUserFeedback()
    }

    await this.metrics.record('rag_query_performance', metrics)

    // –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –æ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if (metrics.responseTime > this.thresholds.maxResponseTime) {
      await this.alerting.notify('Slow query detected', metrics)
    }
  }
}
```

## üöÄ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç —Ç–µ–∫—É—â—É—é RAG —Å–∏—Å—Ç–µ–º—É –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –º–µ—Å—è—Ü–∞)
- **40% —É–ª—É—á—à–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏** –∑–∞ —Å—á–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è
- **60% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞** —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
- **50% —Å–Ω–∏–∂–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫** —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–∞–∫—Ç–æ–≤

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (3-6 –º–µ—Å—è—Ü–µ–≤)
- **–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –¥–ª—è —Ç—ã—Å—è—á –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ** —Å —Ü–µ–ø–æ—á–∫–æ–π –º—ã—Å–ª–µ–π
- **–ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑** —Ç–µ–∫—Å—Ç–∞, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ

### –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç, –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫ –≤—ã–≤–æ–¥–∞–º
- **–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å** - —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–∞—è —Å –≤–µ–¥—É—â–∏–º–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏
- **–ì–∏–±–∫–æ—Å—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤ –æ–±–ª–∞–∫–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ —Å–µ—Ä—å–µ–∑–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ä–µ—à–µ–Ω–∏—è–º –Ω–∞ —Ä—ã–Ω–∫–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

## üìÖ –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ù–µ–¥–µ–ª–∏ 1-8)
- **–ù–µ–¥–µ–ª–∏ 1-3**: –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ + –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
- **–ù–µ–¥–µ–ª–∏ 4-6**: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–∞–π–ø–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **–ù–µ–¥–µ–ª–∏ 7-8**: –§—Ä–µ–π–º–≤–æ—Ä–∫ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞

### –§–∞–∑–∞ 2: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ù–µ–¥–µ–ª–∏ 9-16)
- **–ù–µ–¥–µ–ª–∏ 9-12**: –£–ª—É—á—à–µ–Ω–∏—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–ù–µ–¥–µ–ª–∏ 13-16**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ + –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### –§–∞–∑–∞ 3: –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É (–ù–µ–¥–µ–ª–∏ 17-20)
- **–ù–µ–¥–µ–ª–∏ 17-18**: –£–ª—É—á—à–µ–Ω–∏—è UX + –ü–æ–ª–∏—Ä–æ–≤–∫–∞
- **–ù–µ–¥–µ–ª–∏ 19-20**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ | –¶–µ–ª—å | –°—Ä–æ–∫ |
|---------|---------|------|------|
| –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ | ~60% | >85% | –ù–µ–¥–µ–ª—è 8 |
| –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ | ~70% | >90% | –ù–µ–¥–µ–ª—è 12 |
| –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ | ~30—Å | <10—Å | –ù–µ–¥–µ–ª—è 16 |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ | ~200–ú–ë | <100–ú–ë | –ù–µ–¥–µ–ª—è 16 |
| –£—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ | ~10% | <2% | –ù–µ–¥–µ–ª—è 20 |

---

*–≠—Ç–æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ RAG Documents System –≤ –≥–æ—Ç–æ–≤–æ–µ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É —Ä–µ—à–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.*